<ion-header>
  <ion-toolbar>
    <ion-title>{{ isEditMode ? 'Edit Maintenance' : 'New Maintenance Request' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="close()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading properties...</p>
  </div>

  <div *ngIf="!isLoading">
    <ion-list>
      <ion-item>
        <ion-label position="stacked">Property/Lease *</ion-label>
        <ion-select 
          interface="popover" 
          [(ngModel)]="taskData.leaseId" 
          (ionChange)="onLeaseChange($event.detail.value)"
          placeholder="Select a property">
          <ion-select-option *ngFor="let lease of availableLeases" [value]="lease.leaseId">
            {{ lease.propertyName }}{{ lease.unitNumber ? ' - Unit ' + lease.unitNumber : '' }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Title *</ion-label>
        <ion-input 
          placeholder="Brief description of the issue" 
          [(ngModel)]="taskData.title"
          required>
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Description</ion-label>
        <ion-textarea 
          placeholder="Detailed description of the maintenance issue" 
          [(ngModel)]="taskData.description"
          rows="4">
        </ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Priority</ion-label>
        <ion-select interface="popover" [(ngModel)]="taskData.priority">
          <ion-select-option value="LOW">Low</ion-select-option>
          <ion-select-option value="MEDIUM">Medium</ion-select-option>
          <ion-select-option value="HIGH">High</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Assigned Technician</ion-label>
        <ion-input 
          placeholder="Technician name or company" 
          [(ngModel)]="taskData.assignedTechnician">
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Estimated Cost (TZS)</ion-label>
        <ion-input 
          type="number" 
          placeholder="0" 
          [(ngModel)]="taskData.maintenanceCost">
        </ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Attach Image (Optional)</ion-label>
        <input type="file" accept="image/*" (change)="onAttachmentSelected($event)" />
      </ion-item>

      <ion-item *ngIf="attachmentName" lines="none">
        <ion-label>{{ attachmentName }}</ion-label>
        <ion-button fill="clear" color="medium" (click)="removeAttachment()">
          <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-item>
    </ion-list>

    <div class="action-buttons">
      <ion-button expand="block" fill="outline" (click)="close()">
        Cancel
      </ion-button>
      <ion-button expand="block" (click)="saveTask()" [disabled]="!taskData.title || !taskData.leaseId">
        {{ isEditMode ? 'Update Request' : 'Submit Request' }}
      </ion-button>
    </div>
  </div>
</ion-content>
