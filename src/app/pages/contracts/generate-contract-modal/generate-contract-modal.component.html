<ion-header>
  <ion-toolbar color="light">
    <ion-title class="modal-title">{{ isEditMode ? 'Edit Contract' : 'Generate New Contract' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="dismiss()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="modal-wrapper">

    <div class="form-section">
      <h2 class="section-title">Contract Information</h2>

      <!-- Lease Selection Dropdown (only when creating new) -->
      <ion-item lines="none" *ngIf="!preset && !isEditMode">
        <ion-label position="stacked">Select Lease</ion-label>
        <ion-select 
          [(ngModel)]="selectedLeaseId" 
          (ionChange)="onLeaseSelected()"
          placeholder="Select a lease..."
          interface="popover">
          <ion-select-option *ngFor="let lease of leases" [value]="lease.leaseId">
            {{ lease.displayName }}
          </ion-select-option>
        </ion-select>
        <ion-spinner *ngIf="isLoadingLeases" name="crescent" slot="end"></ion-spinner>
      </ion-item>

      <!-- Template Selection Dropdown -->
      <ion-item lines="none" *ngIf="!isEditMode">
        <ion-label position="stacked">Contract Template</ion-label>
        <ion-select 
          [(ngModel)]="selectedTemplateId" 
          placeholder="Select a template..."
          interface="popover">
          <ion-select-option *ngFor="let template of templates" [value]="template.templateId">
            {{ template.templateName }} {{ template.isDefault ? '(Default)' : '' }}
          </ion-select-option>
        </ion-select>
        <ion-spinner *ngIf="isLoadingTemplates" name="crescent" slot="end"></ion-spinner>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Tenant Name</ion-label>
        <ion-input [(ngModel)]="tenantName" placeholder="Enter tenant name" [readonly]="!isEditMode && selectedLeaseId"></ion-input>
      </ion-item>

      <div class="two-cols">
        <ion-item lines="none">
          <ion-label position="stacked">Property</ion-label>
          <ion-input [(ngModel)]="propertyNumber" [readonly]="!isEditMode && selectedLeaseId"></ion-input>
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Unit Number</ion-label>
          <ion-input [(ngModel)]="unitNumber" [readonly]="!isEditMode && selectedLeaseId"></ion-input>
        </ion-item>
      </div>

      <ion-item lines="none">
        <ion-label position="stacked">Property Address</ion-label>
        <ion-input [(ngModel)]="propertyAddress" placeholder="Full property address"></ion-input>
      </ion-item>

      <div class="two-cols">
        <ion-item lines="none">
          <ion-label position="stacked">Lease Start Date
            <ion-icon name="calendar" size="small"></ion-icon>
          </ion-label>
          <ion-input type="date" [(ngModel)]="leaseStartDate"></ion-input>
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Lease End Date
            <ion-icon name="calendar" size="small"></ion-icon>
          </ion-label>
          <ion-input type="date" [(ngModel)]="leaseEndDate"></ion-input>
        </ion-item>
      </div>

      <div class="two-cols">
        <ion-item lines="none">
          <ion-label position="stacked">Monthly Rent (TZS)</ion-label>
          <ion-input type="number" [(ngModel)]="monthlyRent"></ion-input>
        </ion-item>
        <ion-item lines="none">
          <ion-label position="stacked">Security Deposit (TZS)</ion-label>
          <ion-input type="number" [(ngModel)]="securityDeposit"></ion-input>
        </ion-item>
      </div>

      <ion-item lines="none">
        <ion-label position="stacked">Owner Name</ion-label>
        <ion-input [(ngModel)]="ownerName"></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Owner Address</ion-label>
        <ion-input [(ngModel)]="ownerAddress"></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Special Terms & Conditions</ion-label>
        <ion-textarea
          autoGrow="true"
          [(ngModel)]="specialTerms"
          placeholder="Any special terms or conditions...">
        </ion-textarea>
      </ion-item>

      <ion-button expand="block" color="success" class="generate-btn" (click)="generateContract()" [disabled]="!tenantName">
        {{ isEditMode ? 'Save Changes' : 'Generate Contract' }}
      </ion-button>
    </div>

    <div class="preview-section">
      <h2 class="section-title">Contract Preview</h2>
      <div class="preview-box">
        <pre>
<b>RESIDENTIAL LEASE AGREEMENT</b>

Contract Number: CNT-XXXX-XXX
Generated Date: {{ today }}

<b>LANDLORD:</b> {{ ownerName }}
Address: {{ ownerAddress }}

<b>TENANT:</b> {{ tenantName || 'Tenant Name' }}

<b>PROPERTY:</b> {{ propertyNumber || 'Property' }}, {{ unitNumber || 'Unit' }}

<b>LEASE TERMS:</b>
- Lease Start Date: {{ leaseStartDate || 'Start Date' }}
- Lease End Date: {{ leaseEndDate || 'End Date' }}
- Monthly Rent: TZS {{ monthlyRent }}
- Security Deposit: TZS {{ securityDeposit }}

<b>ADDITIONAL TERMS:</b>
{{ specialTerms || 'Standard lease terms and conditions apply.' }}

___________________________           ___________________________
Landlord Signature                      Tenant Signature

Date: ____________                      Date: ____________
        </pre>
      </div>
    </div>
  </div>
</ion-content>
